<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العملية الانتخابية - حزب مستقبل وطن</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            padding-bottom: 60px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header img {
            height: 70px;
        }
        
        .header-text {
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-right: 10px;
            width: auto;
        }
        
        .counter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }
        
        .counter h3 {
            color: #667eea;
            font-size: 2em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        .user-management {
            margin-top: 20px;
        }
        
        .user-list {
            margin-top: 20px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-danger {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            margin: 0;
        }
        
        .btn-edit {
            background: #17a2b8;
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            margin: 0;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
            width: auto;
            transition: transform 0.2s;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            background: #218838;
        }

        .keyboard-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
        }

        .keyboard-title {
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
        }

        .keyboard-grid {
            display: inline-grid;
            grid-template-columns: repeat(3, 70px);
            gap: 10px;
            margin-bottom: 10px;
        }

        .keyboard-btn {
            width: 70px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .keyboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .keyboard-btn:active {
            transform: translateY(0);
        }

        .keyboard-zero {
            width: 70px;
        }
        
        .keyboard-middle-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .keyboard-clear {
            background: #dc3545;
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 18px;
            height: auto;
        }
        
        .keyboard-backspace {
            background: #ffc107;
            color: #333;
            font-size: 20px;
        }
        
        .national-id-input {
            font-family: monospace;
            letter-spacing: 1px;
        }
        
        .footer {
            text-align: center;
            color: white;
            padding: 15px;
            position: absolute;
            bottom: 0;
            width: 100%;
            left: 0;
            font-size: 0.9em;
        }
        
        .details-modal, .edit-modal, .popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close-modal {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .popup-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .popup-success {
            color: #28a745;
        }
        
        .popup-error {
            color: #dc3545;
        }
        
        .details-list {
            margin-top: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .user-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-details-table th, .user-details-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .user-details-table th {
            background-color: #f8f9fa;
        }

        .close-popup-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .import-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .backup-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .backup-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .restore-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .auto-backup {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header img {
                height: 50px;
            }
            
            .card {
                padding: 20px;
            }
            
            .keyboard-btn {
                width: 60px;
                height: 55px;
                font-size: 20px;
            }
            
            .keyboard-zero {
                width: 60px;
            }
            
            .keyboard-clear {
                padding: 12px;
                font-size: 16px;
            }
            
            .user-actions {
                flex-direction: column;
                gap: 5px;
            }

            .backup-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/ar/0/0d/%D8%B4%D8%B9%D8%A7%D8%B1_%D8%AD%D8%B2%D8%A8_%D9%85%D8%B3%D8%AA%D9%82%D8%A8%D9%84_%D9%88%D8%B7%D9%86_%282020%29.png" alt="شعار حزب مستقبل وطن">
            <div class="header-text">
                <h1>🗳️ نظام إدارة العملية الانتخابية</h1>
                <p>حزب مستقبل وطن - مدينة نصر ثالث</p>
            </div>
        </div>

        <!-- صفحة تسجيل الدخول -->
        <div id="loginPage" class="card">
            <h2 style="text-align: center; margin-bottom: 10px; color: #333;">تسجيل الدخول</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #666;">(نقطة حشد - مقر انتخابي - نقطة صرف)</p>
            <div class="form-group">
                <label>اسم المستخدم</label>
                <input type="text" id="username" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button class="btn" onclick="login()">دخول</button>
        </div>

        <!-- واجهة مسؤول نقطة الحشد -->
        <div id="hashdPage" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #333;">📝 نقطة الحشد</h2>
                <button class="btn btn-secondary" onclick="logout()">خروج</button>
            </div>
            <div class="form-group">
                <label>الرقم القومي (14 رقم)</label>
                <input type="text" id="hashdNationalId" class="national-id-input" placeholder="أدخل الرقم القومي" maxlength="14">
            </div>
            <button class="btn" onclick="registerVoter()">تسجيل ناخب</button>
            
            <!-- لوحة المفاتيح الرقمية -->
            <div class="keyboard-container">
                <div class="keyboard-title">لوحة المفاتيح الرقمية</div>
                <div class="keyboard-grid">
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '1')">1</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '2')">2</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '3')">3</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '4')">4</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '5')">5</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '6')">6</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '7')">7</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '8')">8</button>
                    <button class="keyboard-btn" onclick="addToInput('hashdNationalId', '9')">9</button>
                </div>
                <div class="keyboard-middle-row">
                    <button class="keyboard-btn keyboard-backspace" onclick="backspaceInput('hashdNationalId')">⌫</button>
                    <button class="keyboard-btn keyboard-zero" onclick="addToInput('hashdNationalId', '0')">0</button>
                </div>
                <button class="keyboard-btn keyboard-clear" onclick="clearInput('hashdNationalId')">مسح الكل</button>
            </div>
            <div class="counter">
                <p>عدد المواطنين المسجلين</p>
                <h3 id="hashdCounter">0</h3>
            </div>
        </div>

        <!-- واجهة مسؤول المقر الانتخابي -->
        <div id="maqarrPage" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #333;">🗳️ المقر الانتخابي</h2>
                <button class="btn btn-secondary" onclick="logout()">خروج</button>
            </div>
            <div class="form-group">
                <label>الرقم القومي</label>
                <input type="text" id="maqarrNationalId" class="national-id-input" placeholder="أدخل الرقم القومي" maxlength="14">
            </div>
            <button class="btn" onclick="registerVote()">تسجيل انتخاب</button>
            
            <!-- لوحة المفاتيح الرقمية -->
            <div class="keyboard-container">
                <div class="keyboard-title">لوحة المفاتيح الرقمية</div>
                <div class="keyboard-grid">
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '1')">1</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '2')">2</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '3')">3</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '4')">4</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '5')">5</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '6')">6</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '7')">7</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '8')">8</button>
                    <button class="keyboard-btn" onclick="addToInput('maqarrNationalId', '9')">9</button>
                </div>
                <div class="keyboard-middle-row">
                    <button class="keyboard-btn keyboard-backspace" onclick="backspaceInput('maqarrNationalId')">⌫</button>
                    <button class="keyboard-btn keyboard-zero" onclick="addToInput('maqarrNationalId', '0')">0</button>
                </div>
                <button class="keyboard-btn keyboard-clear" onclick="clearInput('maqarrNationalId')">مسح الكل</button>
            </div>
            <div class="counter">
                <p>عدد المواطنين المنتخبين</p>
                <h3 id="maqarrCounter">0</h3>
            </div>
        </div>

        <!-- واجهة مسؤول نقطة الصرف -->
        <div id="sarafPage" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #333;">💰 نقطة الصرف</h2>
                <button class="btn btn-secondary" onclick="logout()">خروج</button>
            </div>
            <div class="form-group">
                <label>الرقم القومي</label>
                <input type="text" id="sarafNationalId" class="national-id-input" placeholder="أدخل الرقم القومي" maxlength="14">
            </div>
            <button class="btn" onclick="registerDispense()">تسجيل صرف</button>
            
            <!-- لوحة المفاتيح الرقمية -->
            <div class="keyboard-container">
                <div class="keyboard-title">لوحة المفاتيح الرقمية</div>
                <div class="keyboard-grid">
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '1')">1</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '2')">2</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '3')">3</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '4')">4</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '5')">5</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '6')">6</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '7')">7</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '8')">8</button>
                    <button class="keyboard-btn" onclick="addToInput('sarafNationalId', '9')">9</button>
                </div>
                <div class="keyboard-middle-row">
                    <button class="keyboard-btn keyboard-backspace" onclick="backspaceInput('sarafNationalId')">⌫</button>
                    <button class="keyboard-btn keyboard-zero" onclick="addToInput('sarafNationalId', '0')">0</button>
                </div>
                <button class="keyboard-btn keyboard-clear" onclick="clearInput('sarafNationalId')">مسح الكل</button>
            </div>
            <div class="counter">
                <p>عدد المواطنين المصروف لهم</p>
                <h3 id="sarafCounter">0</h3>
            </div>
        </div>

        <!-- واجهة محلل البيانات -->
        <div id="analyticsPage" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #333;">📊 تحليل البيانات</h2>
                <button class="btn btn-secondary" onclick="logout()">خروج</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card" onclick="showDetails('hashd')">
                    <h3 style="color: #28a745;">المسجلين في الحشد</h3>
                    <h2 id="totalHashd">0</h2>
                </div>
                <div class="stat-card" onclick="showDetails('votes')">
                    <h3 style="color: #007bff;">المنتخبين</h3>
                    <h2 id="totalVoted">0</h2>
                </div>
                <div class="stat-card" onclick="showDetails('dispenses')">
                    <h3 style="color: #ffc107;">المصروف لهم</h3>
                    <h2 id="totalDispensed">0</h2>
                </div>
                <div class="stat-card">
                    <h3 style="color: #17a2b8;">نسبة الإقبال</h3>
                    <h2 id="turnoutRate">0%</h2>
                </div>
            </div>
            <button class="btn" onclick="refreshAnalytics()" style="margin-top: 20px;">تحديث البيانات</button>
            <button class="btn-export" onclick="exportAllData()">📊 تصدير جميع البيانات إلى Excel</button>
        </div>

        <!-- واجهة المدير -->
        <div id="adminPage" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #333;">👨‍💼 لوحة المدير</h2>
                <button class="btn btn-secondary" onclick="logout()">خروج</button>
            </div>
            
            <div class="user-management">
                <h3>إضافة مستخدم جديد</h3>
                <div class="form-group">
                    <label>اسم المستخدم</label>
                    <input type="text" id="newUsername" placeholder="اسم المستخدم">
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="text" id="newPassword" placeholder="كلمة المرور">
                </div>
                <div class="form-group">
                    <label>نوع المستخدم</label>
                    <select id="newUserType">
                        <option value="hashd">مسؤول نقطة الحشد</option>
                        <option value="maqarr">مسؤول المقر الانتخابي</option>
                        <option value="saraf">مسؤول نقطة الصرف</option>
                        <option value="analytics">محلل بيانات</option>
                        <option value="supervisor">مشرف</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>اسم النقطة/المقر</label>
                    <input type="text" id="locationName" placeholder="اسم النقطة أو المقر">
                </div>
                <button class="btn" onclick="addUser()">إضافة مستخدم</button>
            </div>

            <div class="user-list">
                <h3>قائمة المستخدمين</h3>
                <div id="usersList"></div>
            </div>

            <div style="margin-top: 30px;">
                <h3>سجلات الدخول والخروج</h3>
                <div id="loginLogsList"></div>
            </div>

            <div class="import-section">
                <h3>استيراد بيانات المواطنين</h3>
                <div class="form-group">
                    <label>رفع ملف Excel</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls">
                </div>
                <button class="btn" onclick="importCitizenData()">استيراد البيانات</button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    يجب أن يحتوي الملف على الأعمدة التالية: الرقم القومي، اسم المواطن، المقر الانتخابي، رقم اللجنة، رقم الكشف
                </p>
            </div>

            <div class="backup-section">
                <h3>النسخ الاحتياطي والاستعادة</h3>
                <p>آخر نسخة احتياطية: <span id="lastBackupTime">لم يتم إنشاء نسخة بعد</span></p>
                
                <div class="backup-controls">
                    <button class="backup-btn" onclick="createBackup()">إنشاء نسخة احتياطية الآن</button>
                    <button class="restore-btn" onclick="restoreBackup()">استعادة من نسخة احتياطية</button>
                </div>
                
                <div class="auto-backup">
                    <input type="checkbox" id="autoBackup" onchange="toggleAutoBackup()">
                    <label for="autoBackup">النسخ الاحتياطي التلقائي كل 30 دقيقة</label>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card" onclick="showDetails('hashd')">
                    <h3 style="color: #28a745;">إجمالي المسجلين</h3>
                    <h2 id="adminTotalHashd">0</h2>
                </div>
                <div class="stat-card" onclick="showDetails('votes')">
                    <h3 style="color: #007bff;">إجمالي المنتخبين</h3>
                    <h2 id="adminTotalVoted">0</h2>
                </div>
                <div class="stat-card" onclick="showDetails('dispenses')">
                    <h3 style="color: #ffc107;">إجمالي المصروف لهم</h3>
                    <h2 id="adminTotalDispensed">0</h2>
                </div>
                <div class="stat-card">
                    <h3 style="color: #17a2b8;">نسبة الإقبال العامة</h3>
                    <h2 id="adminTurnoutRate">0%</h2>
                </div>
            </div>
            <button class="btn" onclick="refreshAdminData()" style="margin-top: 20px;">تحديث البيانات</button>
            <button class="btn-export" onclick="exportCompleteReport()">📊 تصدير التقرير الشامل إلى Excel</button>
        </div>

        <!-- نهاية الصفحة - التوقيع -->
        <div class="footer">
            تم الانشاء بواسطة - محمود علي - امين العضوية
        </div>
    </div>

    <!-- Modal for details -->
    <div id="detailsModal" class="details-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">تفاصيل</h2>
                <button class="close-modal" onclick="closeModal()">إغلاق</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal for editing user -->
    <div id="editUserModal" class="edit-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعديل المستخدم</h2>
                <button class="close-modal" onclick="closeEditModal()">إغلاق</button>
            </div>
            <div class="form-group">
                <label>اسم المستخدم</label>
                <input type="text" id="editUsername" readonly>
            </div>
            <div class="form-group">
                <label>كلمة المرور الجديدة</label>
                <input type="text" id="editPassword" placeholder="أدخل كلمة المرور الجديدة">
            </div>
            <div class="form-group">
                <label>نوع المستخدم</label>
                <select id="editUserType">
                    <option value="hashd">مسؤول نقطة الحشد</option>
                    <option value="maqarr">مسؤول المقر الانتخابي</option>
                    <option value="saraf">مسؤول نقطة الصرف</option>
                    <option value="analytics">محلل بيانات</option>
                    <option value="supervisor">مشرف</option>
                </select>
            </div>
            <div class="form-group">
                <label>اسم النقطة/المقر</label>
                <input type="text" id="editLocationName" placeholder="اسم النقطة أو المقر">
            </div>
            <button class="btn" onclick="updateUser()">حفظ التعديلات</button>
        </div>
    </div>

    <!-- Popup Message Modal -->
    <div id="popupMessage" class="popup-modal hidden" onclick="closePopup()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="popupIcon" class="popup-icon"></div>
            <h3 id="popupText"></h3>
            <div id="popupDetails" style="text-align: right; margin-top: 20px;"></div>
            <button id="closePopupBtn" class="close-popup-btn" onclick="closePopup()">موافق</button>
        </div>
    </div>

    <script>
        // وظائف لوحة المفاتيح الرقمية
        function addToInput(inputId, digit) {
            const input = document.getElementById(inputId);
            if (input.value.length < 14) {
                input.value += digit;
            }
        }

        function backspaceInput(inputId) {
            const input = document.getElementById(inputId);
            input.value = input.value.slice(0, -1);
        }

        function clearInput(inputId) {
            document.getElementById(inputId).value = '';
        }

        // وظائف الرسائل المنبثقة
        function showPopup(message, type = 'success', details = '') {
            const popup = document.getElementById('popupMessage');
            const popupIcon = document.getElementById('popupIcon');
            const popupText = document.getElementById('popupText');
            const popupDetails = document.getElementById('popupDetails');
            const closePopupBtn = document.getElementById('closePopupBtn');
            
            popupIcon.className = 'popup-icon';
            if (type === 'success') {
                popupIcon.classList.add('popup-success');
                popupIcon.innerHTML = '✅';
                closePopupBtn.style.background = '#28a745';
            } else {
                popupIcon.classList.add('popup-error');
                popupIcon.innerHTML = '❌';
                closePopupBtn.style.background = '#dc3545';
            }
            
            popupText.textContent = message;
            popupDetails.innerHTML = details;
            
            popup.classList.remove('hidden');
        }

        function closePopup() {
            document.getElementById('popupMessage').classList.add('hidden');
        }

        // بيانات النظام
        let systemData = {
            users: {
                مدير: { password: 'مدير123', type: 'admin', location: 'الإدارة العامة' },
                حشد1: { password: 'حشد123', type: 'hashd', location: 'نقطة الحشد 1' },
                مقر1: { password: 'مقر123', type: 'maqarr', location: 'مدرسة مدينة نصر الثانوية' },
                صرف1: { password: 'صرف123', type: 'saraf', location: 'نقطة الصرف 1' },
                تحليل: { password: 'تحليل123', type: 'analytics', location: 'قسم البيانات' },
                مشرف1: { password: 'مشرف123', type: 'supervisor', location: 'مشرف عام' }
            },
            registrations: [], // تسجيلات الحشد
            votes: [], // تسجيلات الانتخاب
            dispenses: [], // تسجيلات الصرف
            loginLogs: [], // سجلات الدخول والخروج
            citizenData: {}, // بيانات المواطنين المستوردة
            currentUser: null,
            editingUser: null,
            autoBackupInterval: null,
            lastBackupTime: null
        };

        // وظائف مساعدة
        function validateNationalId(id) {
            return /^\d{14}$/.test(id);
        }

        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString('ar-EG');
        }

        function getCurrentDateTimeForFileName() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}_${hours}-${minutes}`;
        }

        function hideAllPages() {
            const pages = ['loginPage', 'hashdPage', 'maqarrPage', 'sarafPage', 'analyticsPage', 'adminPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // توليد اسم عشوائي (لأغراض العرض فقط)
        function generateRandomName() {
            const firstNames = ['أحمد', 'محمد', 'علي', 'محمود', 'مصطفى', 'خالد', 'عمر', 'ياسين', 'إبراهيم', 'حسن'];
            const lastNames = ['علي', 'حسن', 'إبراهيم', 'محمود', 'عبدالله', 'سعيد', 'فاروق', 'ناصر', 'شعبان', 'مرعي'];
            return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + lastNames[Math.floor(Math.random() * lastNames.length)];
        }

        // توليد بيانات مقر انتخابي عشوائي
        function generateRandomSchool() {
            const schools = [
                'مدرسة مدينة نصر الثانوية',
                'مدرسة النصر الإعدادية',
                'مدرسة المستقبل الابتدائية',
                'مدرسة الحرية الثانوية',
                'مدرسة الأمل الإعدادية'
            ];
            return schools[Math.floor(Math.random() * schools.length)];
        }

        // توليد رقم لجنة عشوائي
        function generateRandomCommittee() {
            return Math.floor(Math.random() * 20) + 1;
        }

        // توليد رقم كشف عشوائي
        function generateRandomList() {
            return Math.floor(Math.random() * 10) + 1;
        }

        // تسجيل الدخول
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showPopup('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }

            if (systemData.users[username] && systemData.users[username].password === password) {
                systemData.currentUser = username;
                
                // تسجيل عملية الدخول
                systemData.loginLogs.push({
                    username: username,
                    action: 'دخول',
                    timestamp: getCurrentDateTime(),
                    userType: systemData.users[username].type,
                    location: systemData.users[username].location
                });
                
                hideAllPages();
                
                const userType = systemData.users[username].type;
                switch(userType) {
                    case 'admin':
                        document.getElementById('adminPage').classList.remove('hidden');
                        loadUsersList();
                        loadLoginLogs();
                        refreshAdminData();
                        break;
                    case 'hashd':
                        document.getElementById('hashdPage').classList.remove('hidden');
                        updateHashdCounter();
                        break;
                    case 'maqarr':
                        document.getElementById('maqarrPage').classList.remove('hidden');
                        updateMaqarrCounter();
                        break;
                    case 'saraf':
                        document.getElementById('sarafPage').classList.remove('hidden');
                        updateSarafCounter();
                        break;
                    case 'analytics':
                        document.getElementById('analyticsPage').classList.remove('hidden');
                        refreshAnalytics();
                        break;
                    case 'supervisor':
                        document.getElementById('analyticsPage').classList.remove('hidden');
                        refreshAnalytics();
                        break;
                }

                // حفظ البيانات بعد تسجيل الدخول
                saveDataToLocalStorage();
            } else {
                showPopup('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        }

        // تسجيل الخروج
        function logout() {
            // تسجيل عملية الخروج
            if (systemData.currentUser) {
                systemData.loginLogs.push({
                    username: systemData.currentUser,
                    action: 'خروج',
                    timestamp: getCurrentDateTime(),
                    userType: systemData.users[systemData.currentUser].type,
                    location: systemData.users[systemData.currentUser].location
                });
            }
            
            systemData.currentUser = null;
            hideAllPages();
            document.getElementById('loginPage').classList.remove('hidden');
            // إعادة تعيين النماذج
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // حفظ البيانات بعد تسجيل الخروج
            saveDataToLocalStorage();
        }

        // تسجيل ناخب في الحشد
        function registerVoter() {
            const nationalId = document.getElementById('hashdNationalId').value;
            
            if (!validateNationalId(nationalId)) {
                showPopup('الرقم القومي غير صحيح - يجب أن يكون 14 رقمًا', 'error');
                return;
            }

            // التحقق من عدم تسجيل نفس الرقم القومي اليوم
            const today = new Date().toDateString();
            const alreadyRegistered = systemData.registrations.find(r => 
                r.nationalId === nationalId && new Date(r.timestamp).toDateString() === today
            );
            
            if (alreadyRegistered) {
                showPopup('تم تسجيل هذا الرقم القومي اليوم مسبقًا', 'error');
                return;
            }

            // استخدام البيانات المستوردة إذا كانت متاحة، أو توليد بيانات عشوائية
            let citizenName, committee, list, school;
            
            if (systemData.citizenData[nationalId]) {
                citizenName = systemData.citizenData[nationalId].name;
                committee = systemData.citizenData[nationalId].committee;
                list = systemData.citizenData[nationalId].list;
                school = systemData.citizenData[nationalId].school;
            } else {
                citizenName = generateRandomName();
                committee = generateRandomCommittee();
                list = generateRandomList();
                school = generateRandomSchool();
            }
            
            const registration = {
                nationalId: nationalId,
                timestamp: getCurrentDateTime(),
                user: systemData.currentUser,
                location: systemData.users[systemData.currentUser].location,
                citizenName: citizenName,
                committee: committee,
                list: list,
                school: school
            };

            systemData.registrations.push(registration);
            
            // عرض تفاصيل التسجيل
            const details = `
                <div style="text-align: right; direction: rtl;">
                    <p><strong>اسم المواطن:</strong> ${citizenName}</p>
                    <p><strong>رقم قومي:</strong> ${nationalId}</p>
                    <p><strong>المقر الانتخابي:</strong> ${school}</p>
                    <p><strong>رقم اللجنة:</strong> ${committee}</p>
                    <p><strong>رقم الكشف:</strong> ${list}</p>
                </div>
            `;
            
            showPopup('تم تسجيل المواطن بنجاح', 'success', details);
            document.getElementById('hashdNationalId').value = '';
            updateHashdCounter();

            // حفظ البيانات بعد التسجيل
            saveDataToLocalStorage();
        }

        // تحديث عداد الحشد
        function updateHashdCounter() {
            const count = systemData.registrations.length;
            document.getElementById('hashdCounter').textContent = count;
        }

        // تسجيل انتخاب
        function registerVote() {
            const nationalId = document.getElementById('maqarrNationalId').value;
            
            if (!validateNationalId(nationalId)) {
                showPopup('الرقم القومي غير صحيح - يجب أن يكون 14 رقمًا', 'error');
                return;
            }

            // البحث عن التسجيل في الحشد
            const registration = systemData.registrations.find(r => r.nationalId === nationalId);
            
            if (!registration) {
                showPopup('هذا المواطن غير مسجل في نقطة الحشد', 'error');
                return;
            }

            // التحقق من الانتخاب المسبق
            const alreadyVoted = systemData.votes.find(v => v.nationalId === nationalId);
            if (alreadyVoted) {
                showPopup(`تم الانتخاب مسبقًا الساعة ${alreadyVoted.timestamp}`, 'error');
                return;
            }

            const vote = {
                nationalId: nationalId,
                timestamp: getCurrentDateTime(),
                user: systemData.currentUser,
                location: systemData.users[systemData.currentUser].location,
                hashdPoint: registration ? registration.location : 'غير معروف'
            };

            systemData.votes.push(vote);
            
            // عرض تفاصيل الانتخاب
            const details = registration ? `
                <div style="text-align: right; direction: rtl;">
                    <p><strong>اسم المواطن:</strong> ${registration.citizenName}</p>
                    <p><strong>رقم قومي:</strong> ${nationalId}</p>
                    <p><strong>نقطة الحشد:</strong> ${registration.location}</p>
                    <p><strong>المقر الانتخابي:</strong> ${systemData.users[systemData.currentUser].location}</p>
                </div>
            ` : '';
            
            showPopup('تم تسجيل الانتخاب بنجاح', 'success', details);
            document.getElementById('maqarrNationalId').value = '';
            updateMaqarrCounter();

            // حفظ البيانات بعد التسجيل
            saveDataToLocalStorage();
        }

        // تحديث عداد الانتخاب
        function updateMaqarrCounter() {
            const count = systemData.votes.length;
            document.getElementById('maqarrCounter').textContent = count;
        }

        // تسجيل صرف
        function registerDispense() {
            const nationalId = document.getElementById('sarafNationalId').value;
            
            if (!validateNationalId(nationalId)) {
                showPopup('الرقم القومي غير صحيح - يجب أن يكون 14 رقمًا', 'error');
                document.getElementById('sarafNationalId').value = '';
                return;
            }

            // التحقق من الانتخاب
            const voted = systemData.votes.find(v => v.nationalId === nationalId);
            if (!voted) {
                showPopup('لم يقم بالانتخاب', 'error');
                document.getElementById('sarafNationalId').value = '';
                return;
            }

            // التحقق من الصرف المسبق
            const alreadyDispensed = systemData.dispenses.find(d => d.nationalId === nationalId);
            if (alreadyDispensed) {
                showPopup(`تم الصرف مسبقًا الساعة ${alreadyDispensed.timestamp}`, 'error');
                document.getElementById('sarafNationalId').value = '';
                return;
            }

            const dispense = {
                nationalId: nationalId,
                timestamp: getCurrentDateTime(),
                user: systemData.currentUser,
                location: systemData.users[systemData.currentUser].location
            };

            systemData.dispenses.push(dispense);
            showPopup('تم تسجيل الصرف بنجاح', 'success');
            document.getElementById('sarafNationalId').value = '';
            updateSarafCounter();

            // حفظ البيانات بعد التسجيل
            saveDataToLocalStorage();
        }

        // تحديث عداد الصرف
        function updateSarafCounter() {
            const count = systemData.dispenses.length;
            document.getElementById('sarafCounter').textContent = count;
        }

        // تحديث تحليل البيانات
        function refreshAnalytics() {
            const totalHashd = systemData.registrations.length;
            const totalVoted = systemData.votes.length;
            const totalDispensed = systemData.dispenses.length;
            const turnoutRate = totalHashd > 0 ? Math.round((totalVoted / totalHashd) * 100) : 0;

            document.getElementById('totalHashd').textContent = totalHashd;
            document.getElementById('totalVoted').textContent = totalVoted;
            document.getElementById('totalDispensed').textContent = totalDispensed;
            document.getElementById('turnoutRate').textContent = turnoutRate + '%';
        }

        // إضافة مستخدم جديد
        function addUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const userType = document.getElementById('newUserType').value;
            const locationName = document.getElementById('locationName').value;

            if (!username || !password || !locationName) {
                showPopup('يرجى ملء جميع الحقول', 'error');
                return;
            }

            if (systemData.users[username]) {
                showPopup('اسم المستخدم موجود مسبقًا', 'error');
                return;
            }

            systemData.users[username] = {
                password: password,
                type: userType,
                location: locationName
            };

            showPopup('تم إضافة المستخدم بنجاح');
            
            // إعادة تعيين النموذج
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('locationName').value = '';
            
            loadUsersList();

            // حفظ البيانات بعد إضافة المستخدم
            saveDataToLocalStorage();
        }

        // تحميل قائمة المستخدمين
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            for (const [username, user] of Object.entries(systemData.users)) {
                const userTypes = {
                    admin: 'مدير النظام',
                    hashd: 'مسؤول نقطة الحشد',
                    maqarr: 'مسؤول المقر الانتخابي',
                    saraf: 'مسؤول نقطة الصرف',
                    analytics: 'محلل بيانات',
                    supervisor: 'مشرف'
                };

                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div>
                        <strong>${username}</strong> - ${userTypes[user.type]}<br>
                        <small>${user.location}</small>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-edit" onclick="editUser('${username}')">تعديل</button>
                        ${username !== 'مدير' ? `<button class="btn btn-danger" onclick="deleteUser('${username}')">حذف</button>` : ''}
                    </div>
                `;
                usersList.appendChild(userItem);
            }
        }

        // تحميل سجلات الدخول
        function loadLoginLogs() {
            const loginLogsList = document.getElementById('loginLogsList');
            loginLogsList.innerHTML = '';
            
            if (systemData.loginLogs.length === 0) {
                loginLogsList.innerHTML = '<p>لا توجد سجلات دخول حتى الآن</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'user-details-table';
            table.innerHTML = `
                <tr>
                    <th>اسم المستخدم</th>
                    <th>نوع المستخدم</th>
                    <th>الإجراء</th>
                    <th>الوقت</th>
                    <th>الموقع</th>
                </tr>
            `;
            
            // عرض آخر 10 سجلات فقط
            const recentLogs = systemData.loginLogs.slice(-10).reverse();
            
            recentLogs.forEach(log => {
                const userTypes = {
                    admin: 'مدير النظام',
                    hashd: 'مسؤول نقطة الحشد',
                    maqarr: 'مسؤول المقر الانتخابي',
                    saraf: 'مسؤول نقطة الصرف',
                    analytics: 'محلل بيانات',
                    supervisor: 'مشرف'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.username}</td>
                    <td>${userTypes[log.userType]}</td>
                    <td>${log.action}</td>
                    <td>${log.timestamp}</td>
                    <td>${log.location}</td>
                `;
                table.appendChild(row);
            });
            
            loginLogsList.appendChild(table);
            
            if (systemData.loginLogs.length > 10) {
                const showAllBtn = document.createElement('button');
                showAllBtn.className = 'btn';
                showAllBtn.textContent = 'عرض جميع السجلات';
                showAllBtn.onclick = () => showAllLoginLogs();
                loginLogsList.appendChild(showAllBtn);
            }
        }

        // عرض جميع سجلات الدخول
        function showAllLoginLogs() {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = 'جميع سجلات الدخول والخروج';
            
            if (systemData.loginLogs.length === 0) {
                modalContent.innerHTML = '<p>لا توجد سجلات دخول حتى الآن</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'user-details-table';
                table.innerHTML = `
                    <tr>
                        <th>اسم المستخدم</th>
                        <th>نوع المستخدم</th>
                        <th>الإجراء</th>
                        <th>الوقت</th>
                        <th>الموقع</th>
                    </tr>
                `;
                
                const reversedLogs = [...systemData.loginLogs].reverse();
                
                reversedLogs.forEach(log => {
                    const userTypes = {
                        admin: 'مدير النظام',
                        hashd: 'مسؤول نقطة الحشد',
                        maqarr: 'مسؤول المقر الانتخابي',
                        saraf: 'مسؤول نقطة الصرف',
                        analytics: 'محلل بيانات',
                        supervisor: 'مشرف'
                    };
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${log.username}</td>
                        <td>${userTypes[log.userType]}</td>
                        <td>${log.action}</td>
                        <td>${log.timestamp}</td>
                        <td>${log.location}</td>
                    `;
                    table.appendChild(row);
                });
                
                modalContent.innerHTML = '';
                modalContent.appendChild(table);
            }
            
            modal.classList.remove('hidden');
        }

        // تعديل مستخدم
        function editUser(username) {
            systemData.editingUser = username;
            const user = systemData.users[username];
            
            document.getElementById('editUsername').value = username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editUserType').value = user.type;
            document.getElementById('editLocationName').value = user.location;
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        // تحديث بيانات المستخدم
        function updateUser() {
            const username = systemData.editingUser;
            const password = document.getElementById('editPassword').value;
            const userType = document.getElementById('editUserType').value;
            const locationName = document.getElementById('editLocationName').value;

            if (!locationName) {
                showPopup('يرجى إدخال اسم الموقع', 'error');
                return;
            }

            systemData.users[username].type = userType;
            systemData.users[username].location = locationName;
            
            if (password) {
                systemData.users[username].password = password;
            }

            showPopup('تم تعديل المستخدم بنجاح');
            
            setTimeout(() => {
                closeEditModal();
                loadUsersList();
                
                // حفظ البيانات بعد التعديل
                saveDataToLocalStorage();
            }, 1500);
        }

        // إغلاق نافذة تعديل المستخدم
        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            systemData.editingUser = null;
        }

        // حذف مستخدم
        function deleteUser(username) {
            if (username === 'مدير') {
                showPopup('لا يمكن حذف حساب المدير', 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف المستخدم: ${username}؟`)) {
                delete systemData.users[username];
                showPopup('تم حذف المستخدم بنجاح');
                loadUsersList();
                
                // حفظ البيانات بعد الحذف
                saveDataToLocalStorage();
            }
        }

        // وظائف تصدير البيانات إلى Excel
        function exportToExcel(data, filename, sheetName) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, filename);
        }

        // تصدير جميع البيانات (محلل البيانات)
        function exportAllData() {
            if (systemData.registrations.length === 0 && systemData.votes.length === 0 && systemData.dispenses.length === 0) {
                showPopup('لا توجد بيانات للتصدير', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();

            // بيانات الحشد
            if (systemData.registrations.length > 0) {
                const hashdData = systemData.registrations.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'اسم المواطن': item.citizenName,
                    'المقر الانتخابي': item.school,
                    'رقم اللجنة': item.committee,
                    'رقم الكشف': item.list,
                    'تاريخ ووقت التسجيل': item.timestamp,
                    'المستخدم': item.user,
                    'موقع النقطة': item.location
                }));
                const hashdWs = XLSX.utils.json_to_sheet(hashdData);
                XLSX.utils.book_append_sheet(wb, hashdWs, 'بيانات الحشد');
            }

            // بيانات الانتخاب
            if (systemData.votes.length > 0) {
                const votesData = systemData.votes.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'تاريخ ووقت الانتخاب': item.timestamp,
                    'المستخدم': item.user,
                    'موقع المقر': item.location,
                    'نقطة الحشد': item.hashdPoint
                }));
                const votesWs = XLSX.utils.json_to_sheet(votesData);
                XLSX.utils.book_append_sheet(wb, votesWs, 'بيانات الانتخاب');
            }

            // بيانات الصرف
            if (systemData.dispenses.length > 0) {
                const dispensesData = systemData.dispenses.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'تاريخ ووقت الصرف': item.timestamp,
                    'المستخدم': item.user,
                    'موقع النقطة': item.location
                }));
                const dispensesWs = XLSX.utils.json_to_sheet(dispensesData);
                XLSX.utils.book_append_sheet(wb, dispensesWs, 'بيانات الصرف');
            }

            // الإحصائيات
            const statsData = [{
                'المؤشر': 'إجمالي المسجلين في الحشد',
                'العدد': systemData.registrations.length
            }, {
                'المؤشر': 'إجمالي المنتخبين',
                'العدد': systemData.votes.length
            }, {
                'المؤشر': 'إجمالي المصروف لهم',
                'العدد': systemData.dispenses.length
            }, {
                'المؤشر': 'نسبة الإقبال على الانتخاب',
                'العدد': systemData.registrations.length > 0 ? `${Math.round((systemData.votes.length / systemData.registrations.length) * 100)}%` : '0%'
            }, {
                'المؤشر': 'نسبة الصرف من المنتخبين',
                'العدد': systemData.votes.length > 0 ? `${Math.round((systemData.dispenses.length / systemData.votes.length) * 100)}%` : '0%'
            }];
            
            const statsWs = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, statsWs, 'الإحصائيات');

            const filename = `انتخابات_النواب_${getCurrentDateTimeForFileName()}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showPopup('تم تصدير جميع البيانات بنجاح');
        }

        // تصدير التقرير الشامل (المدير)
        function exportCompleteReport() {
            const wb = XLSX.utils.book_new();

            // بيانات الحشد
            if (systemData.registrations.length > 0) {
                const hashdData = systemData.registrations.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'اسم المواطن': item.citizenName,
                    'المقر الانتخابي': item.school,
                    'رقم اللجنة': item.committee,
                    'رقم الكشف': item.list,
                    'تاريخ ووقت التسجيل': item.timestamp,
                    'المستخدم': item.user,
                    'موقع النقطة': item.location
                }));
                const hashdWs = XLSX.utils.json_to_sheet(hashdData);
                XLSX.utils.book_append_sheet(wb, hashdWs, 'بيانات الحشد');
            }

            // بيانات الانتخاب
            if (systemData.votes.length > 0) {
                const votesData = systemData.votes.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'تاريخ ووقت الانتخاب': item.timestamp,
                    'المستخدم': item.user,
                    'موقع المقر': item.location,
                    'نقطة الحشد': item.hashdPoint
                }));
                const votesWs = XLSX.utils.json_to_sheet(votesData);
                XLSX.utils.book_append_sheet(wb, votesWs, 'بيانات الانتخاب');
            }

            // بيانات الصرف
            if (systemData.dispenses.length > 0) {
                const dispensesData = systemData.dispenses.map((item, index) => ({
                    'الرقم التسلسلي': index + 1,
                    'الرقم القومي': item.nationalId,
                    'تاريخ ووقت الصرف': item.timestamp,
                    'المستخدم': item.user,
                    'موقع النقطة': item.location
                }));
                const dispensesWs = XLSX.utils.json_to_sheet(dispensesData);
                XLSX.utils.book_append_sheet(wb, dispensesWs, 'بيانات الصرف');
            }

            // بيانات المستخدمين
            const usersData = Object.entries(systemData.users).map(([username, user]) => {
                const userTypes = {
                    admin: 'مدير النظام',
                    hashd: 'مسؤول نقطة الحشد',
                    maqarr: 'مسؤول المقر الانتخابي',
                    saraf: 'مسؤول نقطة الصرف',
                    analytics: 'محلل بيانات',
                    supervisor: 'مشرف'
                };
                
                return {
                    'اسم المستخدم': username,
                    'نوع المستخدم': userTypes[user.type],
                    'الموقع': user.location
                };
            });
            const usersWs = XLSX.utils.json_to_sheet(usersData);
            XLSX.utils.book_append_sheet(wb, usersWs, 'المستخدمين');

            // سجلات الدخول
            if (systemData.loginLogs.length > 0) {
                const loginData = systemData.loginLogs.map((item, index) => {
                    const userTypes = {
                        admin: 'مدير النظام',
                        hashd: 'مسؤول نقطة الحشد',
                        maqarr: 'مسؤول المقر الانتخابي',
                        saraf: 'مسؤول نقطة الصرف',
                        analytics: 'محلل بيانات',
                        supervisor: 'مشرف'
                    };
                    
                    return {
                        'الرقم التسلسلي': index + 1,
                        'اسم المستخدم': item.username,
                        'نوع المستخدم': userTypes[item.userType],
                        'الإجراء': item.action,
                        'الوقت': item.timestamp,
                        'الموقع': item.location
                    };
                });
                const loginWs = XLSX.utils.json_to_sheet(loginData);
                XLSX.utils.book_append_sheet(wb, loginWs, 'سجلات الدخول');
            }

            // الإحصائيات الشاملة
            const statsData = [{
                'المؤشر': 'إجمالي المسجلين في الحشد',
                'العدد': systemData.registrations.length
            }, {
                'المؤشر': 'إجمالي المنتخبين',
                'العدد': systemData.votes.length
            }, {
                'المؤشر': 'إجمالي المصروف لهم',
                'العدد': systemData.dispenses.length
            }, {
                'المؤشر': 'نسبة الإقبال على الانتخاب',
                'العدد': systemData.registrations.length > 0 ? `${Math.round((systemData.votes.length / systemData.registrations.length) * 100)}%` : '0%'
            }, {
                'المؤشر': 'نسبة الصرف من المنتخبين',
                'العدد': systemData.votes.length > 0 ? `${Math.round((systemData.dispenses.length / systemData.votes.length) * 100)}%` : '0%'
            }, {
                'المؤشر': 'إجمالي المستخدمين',
                'العدد': Object.keys(systemData.users).length
            }];
            
            const statsWs = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, statsWs, 'الإحصائيات الشاملة');

            const filename = `انتخابات_النواب_${getCurrentDateTimeForFileName()}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showPopup('تم تصدير التقرير الشامل بنجاح');
        }

        // تحديث بيانات المدير
        function refreshAdminData() {
            refreshAnalytics();
            
            const totalHashd = systemData.registrations.length;
            const totalVoted = systemData.votes.length;
            const totalDispensed = systemData.dispenses.length;
            const turnoutRate = totalHashd > 0 ? Math.round((totalVoted / totalHashd) * 100) : 0;

            document.getElementById('adminTotalHashd').textContent = totalHashd;
            document.getElementById('adminTotalVoted').textContent = totalVoted;
            document.getElementById('adminTotalDispensed').textContent = totalDispensed;
            document.getElementById('adminTurnoutRate').textContent = turnoutRate + '%';
            
            loadLoginLogs();
        }

        // إظهار التفاصيل عند النقر على البطاقات
        function showDetails(type) {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.classList.remove('hidden');
            
            let data = [];
            let title = '';
            
            if (type === 'hashd') {
                title = 'تفاصيل المسجلين في نقاط الحشد';
                // تجميع البيانات حسب الموقع
                const locations = {};
                systemData.registrations.forEach(reg => {
                    if (!locations[reg.location]) {
                        locations[reg.location] = 0;
                    }
                    locations[reg.location]++;
                });
                
                // تحويل إلى مصفوفة للعرض
                data = Object.entries(locations).map(([location, count]) => ({ location, count }));
            } 
            else if (type === 'votes') {
                title = 'تفاصيل المنتخبين في المقار الانتخابية';
                // تجميع البيانات حسب الموقع
                const locations = {};
                systemData.votes.forEach(vote => {
                    if (!locations[vote.location]) {
                        locations[vote.location] = 0;
                    }
                    locations[vote.location]++;
                });
                
                // تحويل إلى مصفوفة للعرض
                data = Object.entries(locations).map(([location, count]) => ({ location, count }));
            }
            else if (type === 'dispenses') {
                title = 'تفاصيل المصروف لهم في نقاط الصرف';
                // تجميع البيانات حسب الموقع
                const locations = {};
                systemData.dispenses.forEach(dispense => {
                    if (!locations[dispense.location]) {
                        locations[dispense.location] = 0;
                    }
                    locations[dispense.location]++;
                });
                
                // تحويل إلى مصفوفة للعرض
                data = Object.entries(locations).map(([location, count]) => ({ location, count }));
            }
            
            modalTitle.textContent = title;
            
            if (data.length === 0) {
                modalContent.innerHTML = '<p>لا توجد بيانات للعرض</p>';
                return;
            }
            
            let html = '<div class="details-list">';
            data.forEach(item => {
                html += `
                    <div class="detail-item">
                        <span>${item.location}</span>
                        <span><strong>${item.count}</strong></span>
                    </div>
                `;
            });
            html += '</div>';
            
            modalContent.innerHTML = html;
        }

        // إغلاق النافذة المنبثقة
        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // استيراد بيانات المواطنين من Excel
        function importCitizenData() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showPopup('يرجى اختيار ملف Excel', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // الحصول على الورقة الأولى
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // مسح البيانات القديمة
                    systemData.citizenData = {};
                    
                    // معالجة البيانات
                    let importedCount = 0;
                    jsonData.forEach(row => {
                        const nationalId = String(row['الرقم القومي']).trim();
                        const name = row['اسم المواطن'];
                        const school = row['المقر الانتخابي'];
                        const committee = row['رقم اللجنة'];
                        const list = row['رقم الكشف'];
                        
                        if (nationalId && nationalId.length === 14 && /^\d+$/.test(nationalId)) {
                            systemData.citizenData[nationalId] = {
                                name: name || 'غير معروف',
                                school: school || 'غير معروف',
                                committee: committee || 1,
                                list: list || 1
                            };
                            importedCount++;
                        }
                    });
                    
                    showPopup(`تم استيراد ${importedCount} مواطن بنجاح`, 'success');
                    fileInput.value = '';
                    
                    // حفظ البيانات بعد الاستيراد
                    saveDataToLocalStorage();
                } catch (error) {
                    console.error('Error importing data:', error);
                    showPopup('حدث خطأ أثناء استيراد البيانات', 'error');
                }
            };
            
            reader.onerror = function() {
                showPopup('حدث خطأ أثناء قراءة الملف', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // حفظ البيانات في LocalStorage
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('voterSystemData', JSON.stringify(systemData));
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        // تحميل البيانات من LocalStorage
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('voterSystemData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // دمج البيانات المحفوظة مع البيانات الافتراضية
                    if (parsedData.users) systemData.users = {...systemData.users, ...parsedData.users};
                    if (parsedData.registrations) systemData.registrations = parsedData.registrations;
                    if (parsedData.votes) systemData.votes = parsedData.votes;
                    if (parsedData.dispenses) systemData.dispenses = parsedData.dispenses;
                    if (parsedData.loginLogs) systemData.loginLogs = parsedData.loginLogs;
                    if (parsedData.citizenData) systemData.citizenData = parsedData.citizenData;
                    if (parsedData.lastBackupTime) systemData.lastBackupTime = parsedData.lastBackupTime;
                    
                    // تحديث وقت آخر نسخة احتياطية
                    if (systemData.lastBackupTime) {
                        document.getElementById('lastBackupTime').textContent = systemData.lastBackupTime;
                    }
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
            }
        }

        // إنشاء نسخة احتياطية
        function createBackup() {
            try {
                const dataStr = JSON.stringify(systemData);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // محاولة استخدام FileSaver.js أو طريقة بديلة لحفظ الملف
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `نسخة_احتياطية_${getCurrentDateTimeForFileName()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // تحديث وقت آخر نسخة احتياطية
                systemData.lastBackupTime = getCurrentDateTime();
                document.getElementById('lastBackupTime').textContent = systemData.lastBackupTime;
                
                showPopup('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
                
                // حفظ وقت النسخة الاحتياطية
                saveDataToLocalStorage();
            } catch (error) {
                console.error('Error creating backup:', error);
                showPopup('حدث خطأ أثناء إنشاء النسخة الاحتياطية', 'error');
            }
        }

        // استعادة من نسخة احتياطية
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // استبدال البيانات الحالية بالبيانات المستعادة
                        if (backupData.users) systemData.users = backupData.users;
                        if (backupData.registrations) systemData.registrations = backupData.registrations;
                        if (backupData.votes) systemData.votes = backupData.votes;
                        if (backupData.dispenses) systemData.dispenses = backupData.dispenses;
                        if (backupData.loginLogs) systemData.loginLogs = backupData.loginLogs;
                        if (backupData.citizenData) systemData.citizenData = backupData.citizenData;
                        if (backupData.lastBackupTime) {
                            systemData.lastBackupTime = backupData.lastBackupTime;
                            document.getElementById('lastBackupTime').textContent = systemData.lastBackupTime;
                        }
                        
                        // حفظ البيانات المستعادة
                        saveDataToLocalStorage();
                        
                        showPopup('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                        
                        // إعادة تحميل واجهة المدير إذا كان المستخدم الحالي هو المدير
                        if (systemData.currentUser && systemData.users[systemData.currentUser].type === 'admin') {
                            loadUsersList();
                            loadLoginLogs();
                            refreshAdminData();
                        }
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        showPopup('حدث خطأ أثناء استعادة النسخة الاحتياطية', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // تفعيل/تعطيل النسخ الاحتياطي التلقائي
        function toggleAutoBackup() {
            const autoBackupCheckbox = document.getElementById('autoBackup');
            
            if (autoBackupCheckbox.checked) {
                // تفعيل النسخ الاحتياطي التلقائي كل 30 دقيقة
                systemData.autoBackupInterval = setInterval(() => {
                    createBackup();
                }, 30 * 60 * 1000); // 30 دقيقة
                
                showPopup('تم تفعيل النسخ الاحتياطي التلقائي', 'success');
            } else {
                // إيقاف النسخ الاحتياطي التلقائي
                if (systemData.autoBackupInterval) {
                    clearInterval(systemData.autoBackupInterval);
                    systemData.autoBackupInterval = null;
                }
                
                showPopup('تم إيقاف النسخ الاحتياطي التلقائي', 'success');
            }
            
            // حفظ إعدادات النسخ الاحتياطي
            saveDataToLocalStorage();
        }

        // السماح بالضغط على Enter لتسجيل الدخول
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات المحفوظة
            loadDataFromLocalStorage();
            
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // التأكد من أن الرقم القومي يحتوي على أرقام فقط
            const nationalIdInputs = document.querySelectorAll('.national-id-input');
            nationalIdInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            });
            
            // التحقق من وجود نسخ احتياطي تلقائي سابق
            const autoBackupCheckbox = document.getElementById('autoBackup');
            if (systemData.autoBackupInterval) {
                autoBackupCheckbox.checked = true;
            }
        });
    </script>
</body>
</html>
